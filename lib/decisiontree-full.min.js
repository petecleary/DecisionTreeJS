/*! DecisionTreeJS - v0.1.0 - Copyright (c) 2013 Pete Cleary*/
(function(){function execute(shape,data,callback,apps,keepProcessedShapes){var processedShapes=[];if(callback=callback||function(){},data||(data={}),keepProcessedShapes||(processedShapes=[]),!shape)return callback();var processedShapes=[],currentShape=shape,processWrapper=function(err,wrShape){if(currentShape=wrShape,err)return callback(err,data,processedShapes);switch(currentShape.processed=!0,currentShape.processCount+=1,currentShape.shapeType.toLowerCase()){case"entry":processedShapes.push(currentShape),nextTick(function(){processWrapper(null,currentShape.nextShape)});break;case"operation":currentShape.nextShape=currentShape.nextShape||{id:-1,shapeType:"Terminator",description:"End"},currentShape.process||(currentShape.process=applyFunctionFromName(currentShape.processName,apps)),currentShape.process(data,currentShape,function(error,crShape){processedShapes.push(crShape),nextTick(function(){processWrapper(error,crShape.nextShape)})});break;case"decision":currentShape.process||(currentShape.process=applyFunctionFromName(currentShape.processName,apps)),currentShape.decide||(currentShape.decide=applyFunctionFromName(currentShape.decideName,apps)),currentShape.nextShape=null,currentShape.process(data,currentShape,function(error,crShape){return processedShapes.push(crShape),err?callback(null,data,processedShapes):(nextTick(function(){decisionWrapper(crShape)}),void 0)});break;case"terminator":return processedShapes.push(currentShape),callback(null,data,processedShapes)}},decisionWrapper=function(wrDecision){wrDecision.decide=wrDecision.decide||function(wrDecision){wrDecision.nextShape=wrDecision.nextShape||(this.paths.length>0?this.paths[0].nextShape:{id:-1,shapeType:"Terminator",description:"End"}),processWrapper(wrDecision.nextShape)},wrDecision.decide(data,wrDecision,decisionComplete)},decisionComplete=function(err,wrDecision){if(!wrDecision.nextShape)for(var foundSelected=!1,x=0;wrDecision.paths.length>x&&(!wrDecision.paths[x].selected||(foundSelected=!0,wrDecision.nextShape=wrDecision.paths[x].nextShape?wrDecision.paths[x].nextShape:findShapeById(wrDecision.paths[x].nextShapeId),!wrDecision.nextShape));x++);wrDecision.nextShape||(err=Error("No following shape found! Check that if using nextShapeId that the id exists")),processWrapper(err,wrDecision.nextShape)},findShapeById=function(id){for(var x=0;processedShapes.length>x;x++)if(processedShapes[x].id===id)return processedShapes[x];return findShapeByIdFromParent(processedShapes[0],id)},findShapeByIdFromParent=function(parent,id){switch(parent.shapeType.toLowerCase()){case"entry":return parent.nextShape.id===id?parent.nextShape:findShapeByIdFromParent(parent.nextShape,id);case"operation":return parent.nextShape.id===id?parent.nextShape:findShapeByIdFromParent(parent.nextShape,id);case"decision":for(var x=0;parent.paths.length>x;x++)if(parent.paths[x].nextShape)return parent.paths[x].nextShape.id===id?parent.paths[x].nextShape:findShapeByIdFromParent(parent.nextShape,id);case"terminator":return null}return null},applyFunctionFromName=function(functionName,apps){for(var context=apps===void 0?window:apps,namespaces=functionName.split("."),func=namespaces.pop(),i=0;namespaces.length>i;i++)context=context[namespaces[i]];return context[func]};processWrapper(null,currentShape)}var root,previous_decisionTree,decisionTree={};root=this,null!=root&&(previous_decisionTree=root.decisionTree);var Entry=function(){function Entry(obj){this.shapeType="Entry",this.inititate=function(){return null},this.id=obj&&obj.id||0,this.description=obj&&obj.description||"Start",this.log=obj&&obj.log||null,this.processed=obj&&obj.processed||!1,this.processCount=obj&&obj.processCount||0,this.nextShape=obj&&obj.nextShape||null}return Entry}();decisionTree.Entry=Entry;var Operation=function(){function Operation(obj){this.shapeType="Operation",this.process=function(data,shape,callback){callback(null,shape)},this.id=obj&&obj.id||0,this.description=obj&&obj.description||"Operation",this.log=obj&&obj.log||null,this.processed=obj&&obj.processed||!1,this.processCount=obj&&obj.processCount||0,this.nextShape=obj&&obj.nextShape||null,this.properties=obj&&obj.properties||null,this.process=obj&&obj.process||function(data,shape,callback){callback(null,shape)},this.processName=obj&&obj.processName||""}return Operation}();decisionTree.Operation=Operation;var Decision=function(){function Decision(obj){this.shapeType="Decision",this.process=function(data,shape,callback){callback(null,shape)},this.decide=function(data,shape,callback){callback(null,shape)},this.id=obj&&obj.id||0,this.description=obj&&obj.description||"Decision",this.log=obj&&obj.log||null,this.processed=obj&&obj.processed||!1,this.processCount=obj&&obj.processCount||0,this.paths=obj&&obj.paths||[],this.properties=obj&&obj.properties||null,this.process=obj&&obj.process||function(data,shape,callback){callback(null,shape)},this.processName=obj&&obj.processName||"",this.nextShape=obj&&obj.nextShape||null,this.decide=obj&&obj.decide||function(data,shape,callback){callback(null,shape)},this.decideName=obj&&obj.decideName||""}return Decision}();decisionTree.Decision=Decision;var DecisionPath=function(){function DecisionPath(obj){this.value=obj&&obj.value||null,this.selected=obj&&obj.selected||!1,this.nextShape=obj&&obj.nextShape||null,this.nextShapeId=obj&&obj.nextShapeId||0}return DecisionPath}();decisionTree.DecisionPath=DecisionPath;var Terminator=function(){function Terminator(obj){this.shapeType="Terminator",this.id=obj&&obj.id||0,this.description=obj&&obj.description||"End",this.log=obj&&obj.log||null,this.processed=obj&&obj.processed||!1,this.processCount=obj&&obj.processCount||0}return Terminator}();decisionTree.Terminator=Terminator,nextTick="undefined"!=typeof process&&process.nextTick?process.nextTick:function(fn){setTimeout(fn,0)},decisionTree.execute=execute,"undefined"!=typeof define&&define.amd?define([],function(){return decisionTree}):"undefined"!=typeof module&&module.exports?module.exports=decisionTree:root.decisionTree=decisionTree})();